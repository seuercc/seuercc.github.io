<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>å‰ªè´´æ¿å†…å®¹è¯»å–å™¨ï¼ˆæ”¹è¿›ç‰ˆï¼‰</title>
    <style>
        :root{
            --bg1:#667eea;
            --bg2:#764ba2;
            --card:#fff;
            --muted:#6b7280;
        }
        html,body{height:100%}
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 980px;
            margin: 0 auto;
            padding: 28px;
            background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            background: var(--card);
            border-radius: 12px;
            padding: 28px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.18);
        }
        h1 {text-align:center;color:#374151;margin-bottom:16px;font-size:2rem}
        .status {
            text-align: left;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-weight: 600;
        }
        .status.info { background:#d1ecf1; color:#0c5460; border:1px solid #bee5eb; }
        .status.success { background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
        .status.error { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }
        .status.copy-success { background:#e8f5e8; color:#2e7d32; border:1px solid #c8e6c9; }
        .info-text {
            background-color: #f1f5f9;
            border-left: 4px solid #60a5fa;
            padding: 12px;
            margin: 12px 0 20px 0;
            border-radius: 0 8px 8px 0;
            color: #374151;
            line-height:1.4;
        }
        .controls { text-align:center;margin-bottom:18px }
        button {
            background: linear-gradient(45deg, var(--bg1), var(--bg2));
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 700;
            margin: 6px;
            transition: transform .18s ease, box-shadow .18s ease;
            box-shadow: 0 6px 18px rgba(0,0,0,0.18);
        }
        button:focus { outline:3px solid rgba(99,102,241,0.2); outline-offset:3px; }
        button:hover { transform: translateY(-3px); box-shadow:0 10px 28px rgba(0,0,0,0.2) }
        button[disabled] { opacity:.6; cursor:not-allowed; transform:none; box-shadow:none; }
        .clipboard-content {
            background-color: #f8fafc;
            border: 1px solid #e6eef8;
            border-radius: 8px;
            padding: 18px;
            margin: 12px 0;
            min-height: 140px;
            white-space: pre-wrap;
            word-break: break-word;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            color:#111827;
        }
        .item { margin-bottom:12px; padding:10px; border-radius:8px; background:#fff; border:1px solid #eef2ff; }
        .item .meta { font-size:12px; color:var(--muted); margin-bottom:8px; }
        img.preview { max-width: 100%; height: auto; border-radius: 6px; display:block; margin-top:6px; border:1px solid #e6eef8; }
        pre.text-content { white-space:pre-wrap; font-family:inherit; font-size:13px; margin:0; background:#f8fafc; padding:8px; border-radius:6px; border:1px dashed #e2e8f0 }
        .small { font-size:12px; color:var(--muted); }
    </style>
</head>
<body>
    <div class="container" role="main">
        <h1>ğŸ“‹ å‰ªè´´æ¿å†…å®¹è¯»å–å™¨ï¼ˆæ”¹è¿›ç‰ˆï¼‰</h1>

        <div id="status" class="status info" aria-live="polite">
            æ­£åœ¨å‡†å¤‡...
        </div>

        <div class="info-text">
            <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
            â€¢ é¡µé¢åŠ è½½æ—¶ä¼šè‡ªåŠ¨å°è¯•è¯»å–å‰ªè´´æ¿ï¼ˆéœ€ HTTPS ä¸”éœ€æˆæƒï¼‰ã€‚<br>
            â€¢ è‹¥è¯»å–å¤±è´¥ä¼šå›é€€åˆ°æ–‡æœ¬è¯»å–ï¼›æ”¯æŒæ–‡æœ¬ä¸å›¾ç‰‡é¢„è§ˆã€‚<br>
            â€¢ å¯¹äºå›¾ç‰‡ï¼Œæµè§ˆå™¨æ˜¯å¦å…è®¸å†™å›å‰ªè´´æ¿å–å†³äºå®ç°ä¸æƒé™ã€‚<br>
            â€¢ ä½ ä¹Ÿå¯ä»¥åœ¨é¡µé¢æŒ‰ Ctrl/Cmd+V ç²˜è´´è§¦å‘è¯»å–ã€‚
        </div>

        <div class="controls" role="toolbar" aria-label="å‰ªè´´æ¿æ“ä½œ">
            <button id="btnRead" type="button">ğŸ”„ é‡æ–°è¯»å–</button>
            <button id="btnCopy" type="button">ğŸ“‹ å¤åˆ¶å†…å®¹</button>
            <button id="btnClear" type="button">ğŸ—‘ï¸ æ¸…ç©ºå†…å®¹</button>
        </div>

        <div id="clipboardContent" class="clipboard-content" aria-live="polite">
            å‰ªè´´æ¿å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º...
        </div>
    </div>

    <script>
        // ç»“æ„åŒ–ä¿å­˜å½“å‰å‰ªè´´æ¿é¡¹ï¼šæ•°ç»„ï¼Œå…ƒç´ å½¢å¦‚ { type, blob?, text?, previewUrl? }
        let currentClipboardItems = [];
        const statusDiv = document.getElementById('status');
        const contentDiv = document.getElementById('clipboardContent');
        const btnRead = document.getElementById('btnRead');
        const btnCopy = document.getElementById('btnCopy');
        const btnClear = document.getElementById('btnClear');

        // åˆå§‹åŒ–æŒ‰é’®äº‹ä»¶
        btnRead.addEventListener('click', readClipboard);
        btnCopy.addEventListener('click', copyToClipboard);
        btnClear.addEventListener('click', clearContent);
        window.addEventListener('load', () => {
            updateStatus('æ­£åœ¨å°è¯•è¯»å–å‰ªè´´æ¿å†…å®¹...', 'info');
            readClipboard();
        });

        // ç›‘å¬ç”¨æˆ·ç²˜è´´ï¼ˆæ›´å¯é ï¼‰
        document.addEventListener('paste', async (ev) => {
            updateStatus('æ£€æµ‹åˆ°ç²˜è´´äº‹ä»¶ï¼Œæ­£åœ¨è¯»å–...', 'info');
            // ä¼˜å…ˆä½¿ç”¨äº‹ä»¶ä¸­çš„ clipboardDataï¼ˆæ›´å³æ—¶ï¼‰
            try {
                const items = [];
                const clipboardData = ev.clipboardData;
                if (clipboardData && clipboardData.items && clipboardData.items.length) {
                    for (const entry of clipboardData.items) {
                        if (entry.kind === 'string') {
                            // è·å–æ–‡æœ¬
                            entry.getAsString(text => {
                                // ç›´æ¥æ¸²æŸ“
                                currentClipboardItems = [{ type: 'text/plain', text }];
                                renderClipboardItems();
                                updateStatus('ç²˜è´´å†…å®¹è¯»å–å®Œæˆ', 'success');
                            });
                        } else if (entry.kind === 'file') {
                            const file = entry.getAsFile();
                            currentClipboardItems = [{ type: file.type || 'application/octet-stream', blob: file }];
                            renderClipboardItems();
                            updateStatus('ç²˜è´´æ–‡ä»¶è¯»å–å®Œæˆ', 'success');
                        }
                    }
                    return;
                }
            } catch (e) {
                // fallthrough to full read
            }
            // fallbackï¼šè°ƒç”¨ readClipboard å®Œæ•´è·¯å¾„
            await readClipboard();
        });

        // è¯»å–å‰ªè´´æ¿ï¼šä¼˜å…ˆå°è¯• navigator.clipboard.read()ï¼Œå›é€€åˆ° readText()
        async function readClipboard() {
            cleanupPreviews();
            currentClipboardItems = [];
            renderClipboardItems();

            if (!navigator.clipboard) {
                updateStatus('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå‰ªè´´æ¿APIï¼ˆnavigator.clipboardï¼‰ã€‚è¯·ä½¿ç”¨ç°ä»£æµè§ˆå™¨ï¼Œå¹¶åœ¨ HTTPS ä¸‹è®¿é—®ã€‚', 'error');
                return;
            }

            // å¯é€‰ï¼šæŸ¥è¯¢æƒé™ï¼ˆéƒ¨åˆ†æµè§ˆå™¨æ”¯æŒï¼‰
            try {
                if (navigator.permissions && navigator.permissions.query) {
                    try {
                        const perm = await navigator.permissions.query({ name: 'clipboard-read' });
                        if (perm.state === 'denied') {
                            updateStatus('å‰ªè´´æ¿è¯»å–æƒé™è¢«æ‹’ç»ï¼ˆPermissions API è¿”å› deniedï¼‰ã€‚è¯·åœ¨æµè§ˆå™¨ä¸­å…è®¸å‰ªè´´æ¿è®¿é—®ã€‚', 'error');
                            return;
                        }
                    } catch (e) {
                        // æŸäº›æµè§ˆå™¨ä¸Š query({name:'clipboard-read'}) ä¼šæŠ›é”™ï¼Œå¿½ç•¥
                    }
                }
            } catch (e) {
                // ignore
            }

            updateStatus('æ­£åœ¨è¯»å–å‰ªè´´æ¿...', 'info');

            // å¦‚æœæ”¯æŒ read(), å…ˆå°è¯• read()
            if (navigator.clipboard.read) {
                try {
                    const clipboardItems = await navigator.clipboard.read();
                    if (!clipboardItems || clipboardItems.length === 0) {
                        // å¯èƒ½å‰ªè´´æ¿ä¸ºç©º
                        updateStatus('å‰ªè´´æ¿ä¸ºç©º', 'info');
                        contentDiv.textContent = 'å‰ªè´´æ¿ä¸­æ²¡æœ‰å†…å®¹';
                        return;
                    }

                    for (const item of clipboardItems) {
                        // item is ClipboardItem
                        for (const type of item.types) {
                            try {
                                const blob = await item.getType(type);
                                if (type.startsWith('text/')) {
                                    const text = await blob.text();
                                    currentClipboardItems.push({ type, text, blob });
                                } else if (type.startsWith('image/')) {
                                    const previewUrl = URL.createObjectURL(blob);
                                    currentClipboardItems.push({ type, blob, previewUrl });
                                } else {
                                    currentClipboardItems.push({ type, blob });
                                }
                            } catch (e) {
                                console.warn('æ— æ³•è¯»å–ç±»å‹', type, e);
                                // è®°å½•ä¸å¯è¯»çš„ç±»å‹
                                currentClipboardItems.push({ type, error: true });
                            }
                        }
                    }
                    renderClipboardItems();
                    updateStatus('âœ… å‰ªè´´æ¿å†…å®¹è¯»å–æˆåŠŸï¼', 'success');
                    return;
                } catch (err) {
                    console.warn('navigator.clipboard.read() å¤±è´¥ï¼Œå°è¯•å›é€€åˆ° readText():', err);
                    // ç»§ç»­åˆ° readText å›é€€é€»è¾‘
                }
            }

            // å›é€€ï¼šå°è¯•åªè¯»å–æ–‡æœ¬ï¼ˆå…¼å®¹æ€§æ›´å¥½ï¼‰
            if (navigator.clipboard.readText) {
                try {
                    const text = await navigator.clipboard.readText();
                    if (!text) {
                        updateStatus('å‰ªè´´æ¿ä¸ºç©ºæˆ–æ— æ–‡æœ¬å¯è¯»', 'info');
                        contentDiv.textContent = 'å‰ªè´´æ¿ä¸­æ²¡æœ‰æ–‡æœ¬å†…å®¹';
                        return;
                    }
                    currentClipboardItems = [{ type: 'text/plain', text }];
                    renderClipboardItems();
                    updateStatus('âœ… å‰ªè´´æ¿æ–‡æœ¬è¯»å–æˆåŠŸï¼ˆreadTextï¼‰ï¼', 'success');
                    return;
                } catch (err) {
                    console.error('readText å¤±è´¥ï¼š', err);
                    updateStatus(`è¯»å–å‰ªè´´æ¿å¤±è´¥ï¼š${err?.message || String(err)}`, 'error');
                    return;
                }
            }

            // æœ€åå…œåº•
            updateStatus('æ— æ³•è¯»å–å‰ªè´´æ¿ï¼šä¸æ”¯æŒ read() å’Œ readText()ã€‚è¯·ä½¿ç”¨æ”¯æŒå‰ªè´´æ¿APIçš„ç°ä»£æµè§ˆå™¨ï¼ˆHTTPS ä¸‹ï¼‰ã€‚', 'error');
        }

        // æ¸²æŸ“ clipboardItemsï¼ˆæŠŠæ–‡æœ¬ä¸å›¾ç‰‡æ˜¾ç¤ºåœ¨ contentDivï¼‰
        function renderClipboardItems() {
            contentDiv.innerHTML = '';
            if (!currentClipboardItems || currentClipboardItems.length === 0) {
                contentDiv.textContent = 'å‰ªè´´æ¿å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º...';
                return;
            }
            for (const item of currentClipboardItems) {
                const wrapper = document.createElement('div');
                wrapper.className = 'item';
                const meta = document.createElement('div');
                meta.className = 'meta';
                meta.textContent = item.type ? `[${item.type}]` : '[unknown]';
                wrapper.appendChild(meta);

                if (item.error) {
                    const p = document.createElement('div');
                    p.className = 'small';
                    p.textContent = 'æ— æ³•è¯»å–è¯¥ç±»å‹çš„å†…å®¹ï¼ˆè¢«æµè§ˆå™¨æˆ–æƒé™é™åˆ¶ï¼‰';
                    wrapper.appendChild(p);
                } else if (item.text) {
                    const pre = document.createElement('pre');
                    pre.className = 'text-content';
                    pre.textContent = item.text;
                    wrapper.appendChild(pre);
                } else if (item.previewUrl) {
                    const info = document.createElement('div');
                    info.className = 'small';
                    info.textContent = `å›¾ç‰‡ï¼ˆ${item.type}ï¼‰ - é¢„è§ˆï¼š`;
                    wrapper.appendChild(info);
                    const img = document.createElement('img');
                    img.className = 'preview';
                    img.src = item.previewUrl;
                    img.alt = 'å‰ªè´´æ¿å›¾ç‰‡é¢„è§ˆ';
                    wrapper.appendChild(img);

                    if (item.blob && typeof item.blob.size === 'number') {
                        const size = document.createElement('div');
                        size.className = 'small';
                        size.textContent = `å¤§å°ï¼š${item.blob.size} å­—èŠ‚`;
                        wrapper.appendChild(size);
                    }
                } else if (item.blob) {
                    const info = document.createElement('div');
                    info.className = 'small';
                    info.textContent = `äºŒè¿›åˆ¶æ•°æ®ï¼ˆ${item.type || 'unknown'}ï¼‰ï¼Œå¤§å°ï¼š${item.blob.size || 'æœªçŸ¥'} å­—èŠ‚`;
                    wrapper.appendChild(info);
                    // å¯æä¾›ä¸‹è½½é“¾æ¥
                    try {
                        const url = URL.createObjectURL(item.blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.textContent = 'ä¸‹è½½';
                        a.download = 'clipboard-item';
                        a.style.marginLeft = '8px';
                        a.addEventListener('click', () => setTimeout(() => URL.revokeObjectURL(url), 10000));
                        wrapper.appendChild(a);
                    } catch (e) {
                        // ignore
                    }
                } else {
                    const p = document.createElement('div');
                    p.className = 'small';
                    p.textContent = 'æ²¡æœ‰å¯å±•ç¤ºçš„å†…å®¹';
                    wrapper.appendChild(p);
                }
                contentDiv.appendChild(wrapper);
            }
        }

        // å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼šä¼˜å…ˆæ–‡æœ¬ï¼Œå…¶æ¬¡å°è¯•å¤åˆ¶å›¾ç‰‡ï¼ˆå¦‚æœæ”¯æŒï¼‰
        async function copyToClipboard() {
            if (!currentClipboardItems || currentClipboardItems.length === 0) {
                alert('æ²¡æœ‰å†…å®¹å¯å¤åˆ¶');
                return;
            }

            // ä¼˜å…ˆå¯»æ‰¾ text ç±»å‹
            const textItem = currentClipboardItems.find(i => i.text);
            if (textItem && navigator.clipboard && navigator.clipboard.writeText) {
                try {
                    await navigator.clipboard.writeText(textItem.text);
                    flashStatus('âœ… æ–‡æœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'copy-success');
                    return;
                } catch (e) {
                    console.error('writeText å¤±è´¥ï¼š', e);
                    alert('å¤åˆ¶æ–‡æœ¬å¤±è´¥ï¼š' + (e?.message || e));
                    return;
                }
            }

            // æ²¡æœ‰æ–‡æœ¬ï¼Œå°è¯•å†™å…¥å›¾ç‰‡ï¼ˆéœ€è¦æµè§ˆå™¨æ”¯æŒ navigator.clipboard.write + ClipboardItemï¼‰
            const imageItem = currentClipboardItems.find(i => i.blob && i.type && i.type.startsWith('image/'));
            if (imageItem && navigator.clipboard && navigator.clipboard.write && window.ClipboardItem) {
                try {
                    const clipItem = new ClipboardItem({ [imageItem.type]: imageItem.blob });
                    await navigator.clipboard.write([clipItem]);
                    flashStatus('âœ… å›¾ç‰‡å·²å†™å…¥å‰ªè´´æ¿ï¼ˆè‹¥æµè§ˆå™¨æ”¯æŒï¼‰ï¼', 'copy-success');
                    return;
                } catch (e) {
                    console.error('å†™å…¥å›¾ç‰‡åˆ°å‰ªè´´æ¿å¤±è´¥ï¼š', e);
                    alert('å†™å…¥å›¾ç‰‡åˆ°å‰ªè´´æ¿å¤±è´¥ï¼š' + (e?.message || e));
                    return;
                }
            }

            alert('å½“å‰å†…å®¹ä¸å¯å¤åˆ¶ä¸ºçº¯æ–‡æœ¬ï¼Œä¸”æµè§ˆå™¨ä¸æ”¯æŒå°†äºŒè¿›åˆ¶å†™å›å‰ªè´´æ¿ã€‚');
        }

        // æ¸…ç©ºæ˜¾ç¤ºå¹¶é‡Šæ”¾é¢„è§ˆ URL
        function clearContent() {
            cleanupPreviews();
            currentClipboardItems = [];
            renderClipboardItems();
            updateStatus('å†…å®¹å·²æ¸…ç©ºï¼Œç‚¹å‡»"é‡æ–°è¯»å–"è·å–æ–°çš„å‰ªè´´æ¿å†…å®¹', 'info');
        }

        // æ¸…é™¤é¢„è§ˆ URLï¼ˆé‡Šæ”¾å†…å­˜ï¼‰
        function cleanupPreviews() {
            if (!currentClipboardItems) return;
            for (const it of currentClipboardItems) {
                if (it.previewUrl) {
                    try { URL.revokeObjectURL(it.previewUrl); } catch (e) { /* ignore */ }
                    it.previewUrl = null;
                }
            }
        }

        // æ›´æ–°çŠ¶æ€æ 
        function updateStatus(text, type='info') {
            statusDiv.className = 'status ' + (type || 'info');
            statusDiv.textContent = text;
        }

        // çŸ­æš‚æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæ ·å¼å¹¶è¿˜åŸ
        function flashStatus(text, cls='copy-success', timeout=2000) {
            const originalText = statusDiv.textContent;
            const originalClass = statusDiv.className;
            statusDiv.className = 'status ' + cls;
            statusDiv.textContent = text;
            setTimeout(() => {
                statusDiv.className = originalClass;
                statusDiv.textContent = originalText;
            }, timeout);
        }

        // æ³¨ï¼šæŸäº›æµè§ˆå™¨æä¾› navigator.clipboard.addEventListener('clipboardchange')ï¼Œä½†æ”¯æŒå¾ˆå°‘ä¸”è¡Œä¸ºä¸ä¸€è‡´ã€‚
        // å¦‚æœä½ å¸Œæœ›è‡ªåŠ¨åœ¨å‰ªè´´æ¿å˜æ›´æ—¶è¯»å–ï¼Œå¯ä»¥åœ¨æ”¯æŒçš„ç¯å¢ƒä¸‹å¢åŠ è½®è¯¢æˆ–ç”¨æˆ·äº¤äº’è§¦å‘çš„è¯»å–ã€‚
    </script>
</body>
</html>
